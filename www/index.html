<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basis CAPI Transcoder Test</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        #output {
            margin-top: 1em; 
            padding: 1em; 
            background-color: #f0f0f0; 
            border: 1px solid #ccc;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Basis CAPI Transcoder Test</h1>
    <p>Testing `basis_capi_compute_transcoded_image_size_in_bytes` function.</p>
    <p>Result will be shown below and in the developer console.</p>
    <div id="output"></div>

    <script type="module">
        // The build artifacts are expected to be in a sibling `build` directory
        import BASIS from '../build/basis_capi_transcoder.js';

        async function runTest() {
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = 'Loading module...';

            try {
                outputDiv.textContent = 'Fetching wasm binary...';
                const wasmResponse = await fetch('../build/basis_capi_transcoder.wasm');
                const wasmBinary = await wasmResponse.arrayBuffer();
                outputDiv.textContent = 'Wasm binary fetched.';

                const basisModule = await BASIS({
                    wasm: wasmBinary
                });
                outputDiv.textContent = 'Module loaded. Cwrapping function...';

                console.log('Inspecting basisModule object:', basisModule);

                const computeSize = basisModule.cwrap(
                    'basis_capi_compute_transcoded_image_size_in_bytes',
                    'number',
                    ['number', 'number', 'number']
                );

                outputDiv.textContent = 'Function wrapped. Running test...';

                // Test with some example values.
                // From basisu_transcoder.h: cTFETC1_RGB = 0
                const target_format = 0; 
                const width = 512;
                const height = 512;

                const sizeInBytes = computeSize(target_format, width, height);

                const resultText = `basis_capi_compute_transcoded_image_size_in_bytes(\n  format: ${target_format} (ETC1_RGB),\n  width: ${width},\n  height: ${height}\n) = ${sizeInBytes} bytes`;
                
                console.log(resultText);
                outputDiv.textContent = `Test finished. Result:\n\n${resultText}`;

            } catch (err) {
                console.error('Test failed:', err);
                outputDiv.textContent = `Test failed: ${err}`;
            }
        }

        runTest();
    </script>
</body>
</html>
