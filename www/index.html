<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basis CAPI Transcoder Test (Safe Mode)</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        #output {
            margin-top: 1em; 
            padding: 1em; 
            background-color: #f0f0f0; 
            border: 1px solid #ccc;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Basis CAPI Transcoder Test (Safe Mode)</h1>
    <p>Testing `basis_capi_compute_transcoded_image_size_in_bytes` function.</p>
    <p>Result will be shown below and in the developer console.</p>
    <div id="output"></div>

    <!-- Load the Emscripten-generated JS file, which creates the global BASIS factory function -->
    <script src="../build/basis_capi_transcoder.js"></script>

    <script>
        const outputDiv = document.getElementById('output');
        outputDiv.textContent = 'Loading module...';

        // The BASIS factory function is now global. 
        // It returns a promise that resolves with the module instance.
        BASIS({
            locateFile: (path, prefix) => {
                if (path.endsWith('.wasm')) {
                    return '../build/basis_capi_transcoder.wasm';
                }
                return prefix + path;
            }
        }).then(basisModule => {
            runTest(basisModule);
        }).catch(err => {
            console.error('Module loading failed:', err);
            outputDiv.textContent = `Module loading failed: ${err}`;
        });

        function runTest(basisModule) {
            try {
                outputDiv.textContent = 'Module loaded. Cwrapping function...';
                console.log('Inspecting basisModule object:', basisModule);

                const computeSize = basisModule.cwrap(
                    'basis_capi_compute_transcoded_image_size_in_bytes',
                    'number',
                    ['number', 'number', 'number']
                );

                outputDiv.textContent = 'Function wrapped. Running test...';

                const target_format = 0; // ETC1_RGB
                const width = 512;
                const height = 512;

                const sizeInBytes = computeSize(target_format, width, height);

                const resultText = `basis_capi_compute_transcoded_image_size_in_bytes(
  format: ${target_format} (ETC1_RGB),
  width: ${width},
  height: ${height}
) = ${sizeInBytes} bytes`;
                
                console.log(resultText);
                outputDiv.textContent = `Test finished. Result:\n\n${resultText}`;

            } catch (err) {
                console.error('Test failed:', err);
                outputDiv.textContent = `Test failed: ${err}`;
            }
        }
    </script>
</body>
</html>